/* GloryLands API Javascript API - Compressed with YUI compressor */ 
/* (C) Copyright 2007-09 John Haralampidis. Licenced under the GNU/GPL Licence */ 
 
var isInternetExplorer=(navigator.userAgent.indexOf("MSIE")>=0);var isMozilla=(navigator.userAgent.indexOf("Gecko")>=0);var isOpera=(navigator.userAgent.indexOf("Opera")>=0);function $trace(a,b){ans="";$each(a,function(e,d){if($type(e)!="function"){if(ans!=""){ans+=", "}if(!b){ans+="["+d+"] = "+e}else{ans+="["+d+"] = {"+$trace(e,b-1)+"}"}}});return ans}var CBChain=new Class({initialize:function(){this.chain=[]},register:function(b,a){if(!$defined(this.chain[b])){this.chain[b]=[]}this.chain[b].push(a)},call:function(j,h,g,d,b,a){if($defined(this.chain[j])){try{this.chain[j].each(function(k){k(h,g,d,b,a)})}catch(f){}}}});var callback=new CBChain();var GLImageLoader=new Class({elements:{},clear:function(){for(var a=0;a<this.elements.length;a++){try{this.elements[a].remove()}catch(b){}}this.elements=[]},replace:function(a,b){var e=this.get(b);if(!e){return a}var d=a.getParent();var f=a.getStyles("left","top");e.inject(d);e.setStyles({left:f.left.toInt(),top:f.top.toInt()});a.remove();return e},get:function(a){if($defined(this.elements[a])){return this.elements[a].clone()}else{return new Element("img",{src:a})}},preload:function(a,b){if(!$defined(b.onProgress)){b.onProgress=function(){}}if(!$defined(b.onComplete)){b.onComplete=function(){}}var k=0;var d=a.length;var g=[];var l=this;var j=function(n,o){var m=n.getProperty("index");if(!o){n=false}if(!$defined(g[m])){g[m]=n;l.elements[a[m]]=n;b.onProgress(m,n);k++;if(k==d){b.onComplete(g)}}};for(var f=0;f<a.length;f++){var e=new Element("img",{index:f});e.addEvent("load",function(m){j(this,true)});e.addEvent("error",function(m){j(this,false)});e.addEvent("abort",function(m){j(this,false)});if($defined(this.elements[a[f]])){var h=this.elements[a[f]];if(h!=false){h.setProperty("id",f);j(h,true);continue}}e.src=a[f];if(e.width&&e.height){e.fireEvent("load",e,1)}if(e.complete){e.fireEvent("load",e,1)}}}});var ImageLoader=new GLImageLoader();var GLInterval=new Class({intervals:[],last_id:0,initialize:function(){setInterval(this.interval,100)},add:function(b,a,e){this.last_id++;var d={func:b,delay:Math.round(a/100),count:0,param:e,id:this.last_id};this.intervals.push(d);return d.id},remove:function(b){for(var a in this.intervals){if($type(a)!="function"){if(this.intervals[a].id==b){this.intervals.splice(a,1);return}}}},interval:function(){var a=Interval.intervals;a.each(function(d,b){d.count++;if(d.count>=d.delay){d.count=0;d.func(d.param)}})}});var Interval=new GLInterval();function getScrollPosition(){var b=0;var d=0;if(typeof(window.pageYOffset)=="number"){b=window.pageXOffset;d=window.pageYOffset}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){b=document.documentElement.scrollLeft;d=document.documentElement.scrollTop}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){b=document.body.scrollLeft;d=document.body.scrollTop}}}var a={x:b,y:d};return a}var waiterShown=false;var waiterFX=false;var waiterDisposer=0;function initWaiter(){waiterFX=new Fx.Styles("waiter",{duration:400,transition:Fx.Transitions.Back.easeIn,onComplete:function(){if(!waiterShown){$("waiter_host").setStyles({display:"none"})}}});$("waiter_host").setStyles({display:"none"})}function showStatus(d,a){try{if(waiterDisposer>0){clearTimeout(waiterDisposer);waiterDisposer=0}if(!d){if(waiterShown){waiterShown=false;waiterFX.stop();waiterFX.start({opacity:0})}}else{$("waiter").setHTML(d);if(!waiterShown){$("waiter_host").setStyles({display:""});$("waiter_host").setStyles({"z-index":lastZ});waiterShown=true;waiterFX.stop();waiterFX.start({opacity:1})}if(a){waiterDisposer=setTimeout(function(){showStatus()},a)}}}catch(b){}}var winCache=[];var winStack=[];var lastZ=250100;function rect_collide(b,a){if((b.l>=a.l)&&(b.l<=a.r)&&(b.t>=a.t)&&(b.t<=a.b)){return true}if((a.l>=b.l)&&(a.l<=b.r)&&(a.t>=b.t)&&(a.t<=b.b)){return true}return false}function draggable_win_align(g){var b=false;var h=g.getPosition();var a=g.getSize().size;var f={l:h.x,t:h.y,r:h.x+a.x,b:h.y+a.y};var d=$(document.body).getSize().size;var e;winStack.each(function(m){try{var n=m.getPosition();var j=m.getSize().size;var k={l:n.x,t:n.y,r:n.x+j.x,b:n.y+j.y};if(rect_collide(k,f)){b={x:n.x+16,y:n.y+16};return}}catch(l){}});if(b!=false){g.setStyle("top",b.y);g.setStyle("left",b.x)}}function createWindow(g,k,q,n,r,j,m){if(!winCache[g]){var a=document.createElement("div");var f=document.createElement("div");var e=document.createElement("span");var p=document.createElement("a");var o=document.createElement("a");if(!isInternetExplorer){a.setAttribute("class","container");f.setAttribute("class","dragger");e.setAttribute("class","content");p.setAttribute("class","toggle");o.setAttribute("class","dispose")}else{a.setAttribute("className","container");f.setAttribute("className","dragger");e.setAttribute("className","content");p.setAttribute("className","toggle");o.setAttribute("className","dispose")}p.setAttribute("title","Minimize");o.setAttribute("title","Close");f.innerHTML='<span align="top" class="left">&nbsp;</span><span class="center">'+g+'</span><span class="right">&nbsp;</span>';a.appendChild(f);a.appendChild(e);e.innerHTML=k;if(!isMozilla){var b=new Fx.Slide(e)}p.setAttribute("href","javascript:;");p.innerHTML="&nbsp;";f.appendChild(p);$(p).addEvent("click",function(d){d=new Event(d);if(!isMozilla){b.toggle()}else{if(e.style.display=="none"){e.style.display=""}else{e.style.display="none"}}d.stop()});o.setAttribute("href","javascript:void(null)");o.innerHTML="&nbsp;";f.appendChild(o);$(o).addEvent("click",function(d){d=new Event(d);gloryIO("?a=window.closed&guid="+m,false,true);delete winCache[g];winStack.remove(a);a.remove();d.stop()});$(f).addEvent("mousedown",function(d){a.setStyles({opacity:0.7,"z-index":lastZ++})});$(f).addEvent("mouseup",function(d){a.setStyles({opacity:1})});$(a).addEvent("mousedown",function(d){a.setStyles({"z-index":lastZ++})});$(a).addEvent("click",function(d){new Event(d).stop()});if(q){a.setStyles({left:q})}if(n){a.setStyles({top:n})}if(r){a.setStyles({width:r})}if(j){a.setStyles({height:j})}a.setStyles({"z-index":lastZ++});document.body.appendChild(a);draggable_win_align(a);var l=new Drag.Move(a,{handle:f});winCache[g]=[a,e,b];winStack.push(a);return a}else{var a=winCache[g][0];var e=winCache[g][1];var b=winCache[g][2];if(!isMozilla){b.slideIn()}else{e.style.display=""}e.innerHTML=k;if(r){a.setStyles({width:r})}if(j){a.setStyles({height:j})}}}var data_cache=[];var ex_buffer_data="";function initDisplayBuffer(){ex_buffer_data=$("databuffer").innerHTML}function clearDisplayBuffer(){$("databuffer").setHTML("")}function displayBuffer(b,a,e,d){map_reset();wgrid_dispose();$("databuffer").setStyle("visibility","visible");$("datapane").setStyle("visibility","hidden");$("datahost").setStyles({"background-image":""});var f=b;if(d!=""){if(a!=""){if(e!=""){f+='<span class="maplabel"><a class="navlink" href="javascript:gloryIO(\''+a+'\',false,true);"><img align="absmiddle" src="images/'+e+'" /></a> '+d+"</span>"}else{f+='<span class="maplabel"><a class="navlink" href="javascript:gloryIO(\''+a+"',false,true);\"> "+d+"</a></span>"}}else{if(e!=""){f+='<span class="maplabel"><img align="absmiddle" src="images/'+e+'" /> '+d+"</span>"}else{f+='<span class="maplabel"> '+d+"</span>"}}}f+=ex_buffer_data;$("databuffer").setHTML(f)}var ddw_visible=false;function ddwin_change(b){var a=ddwin_prepare();a.chain=function(){gloryIO(b,false,true)}}function ddwin_dispose(){if(ddw_visible){var a=new Fx.Styles("dd_popup",{duration:500,transition:Fx.Transitions.Cubic.easeOut});var e=new Fx.Styles("dd_content",{duration:500,transition:Fx.Transitions.Cubic.easeOut});var b=$("dd_popup");var d=$("dd_host");var f=$("dd_content");e.start({opacity:0}).chain(function(){f.setHTML("");a.start({opacity:0,width:10,height:10}).chain(function(){d.setStyles({display:"none"})})});ddw_visible=false}}function ddwin_show(e,a,j){var d=$("dd_popup");var h=$("dd_content");var g=$("dd_host");var b=new Fx.Styles("dd_popup",{duration:500,transition:Fx.Transitions.Cubic.easeOut});var f=new Fx.Styles("dd_content",{duration:500,transition:Fx.Transitions.Cubic.easeOut});if(ddw_visible){f.start({opacity:0}).chain(function(){b.start({height:a,width:e,opacity:1}).chain(function(){h.setHTML('<div style="position:relative; width:100%; height:100%"><span class="dd_head"><a href="javascript:ddwin_dispose()">X</a></span>'+j+"</div>");f.start({opacity:1})})})}else{g.setStyles({display:"","z-index":lastZ++});d.setStyles({opacity:0,width:10,height:10});h.setStyles({opacity:0,display:"none"});h.setHTML('<div style="position:relative; width:100%; height:100%"><span class="dd_head"><a href="javascript:ddwin_dispose()">X</a></span>'+j+"</div>");b.start({opacity:1,width:e,height:a}).chain(function(){h.setStyles({display:""});f.start({opacity:1})});ddw_visible=true}}function ddwin_prepare(){var d=$("dd_popup");var g=$("dd_content");var f=$("dd_host");var a=new Fx.Styles("dd_popup",{duration:500,transition:Fx.Transitions.Cubic.easeOut});var e=new Fx.Styles("dd_content",{duration:500,transition:Fx.Transitions.Cubic.easeOut});var b={chain:null};if(!ddw_visible){f.setStyles({display:"","z-index":lastZ++});d.setStyles({opacity:0});g.setStyles({opacity:1});g.setHTML('Please&nbsp; <img src="images/UI/loading2.gif" align="absmiddle" /> &nbsp;wait...');ddw_visible=true;b=a.start({opacity:1,width:120,height:20}).chain(b.chain)}else{e.start({opacity:0}).chain(function(){g.setHTML('Please&nbsp; <img src="images/UI/loading2.gif" align="absmiddle" /> &nbsp;wait...');e.start({opacity:1});b=a.start({width:120,height:20}).chain(b.chain)})}return b}var msgstack=[];var msglocked=false;function lockMessages(a){msglocked=a;if(!a){$each(msgstack,function(b,d){handleMessages(b)});msgstack=[]}}function handleMessages(g){if(msglocked){msgstack.push(g);return}var m="",t="";for(var l=0;l<g.count;l++){if($defined(g.message[l])){m=g.message[l][0];t=g.message[l][1];if($defined($("datapane"))){if(m=="UPDATEGRID"){gloryIO("?a=map.grid.get&quick=1",false,true)}else{if(m=="RECT"){var a=$("grid_rect");try{if($defined(a)){if(t){rectinfo.w=1;rectinfo.h=1;rectinfo.bx=0;rectinfo.by=0;rectinfo.url="";rectinfo.clickdispose=true;rectinfo.silent=false;if($defined(g.message[l][2])){rectinfo.url=g.message[l][2]}if($defined(g.message[l][3])){rectinfo.w=g.message[l][3]}if($defined(g.message[l][4])){rectinfo.h=g.message[l][4]}if($defined(g.message[l][5])){rectinfo.bx=g.message[l][5]}if($defined(g.message[l][6])){rectinfo.by=g.message[l][6]}if($defined(g.message[l][7])){rectinfo.clickdispose=g.message[l][7]}if($defined(g.message[l][8])){rectinfo.silent=g.message[l][8]}a.setStyles({display:""})}else{a.setStyles({display:"none"})}}}catch(p){window.alert("RECT Error"+p)}}else{if(m=="ALTER"){if($defined(g.message[l][1].guid)){var n=map_objectid_fromguid(g.message[l][1].guid);if(n==0){continue}map_updateobject(n,g.message[l][1])}}else{if(m=="ANIMATE"){var n=map_objectid_fromguid(g.message[l][1]);if(n==0){continue}var k=[];var f=25;var u=1;if($defined(g.message[l][2])){k=g.message[l][2]}if($defined(g.message[l][3])){f=g.message[l][3]}if($defined(g.message[l][4])){u=g.message[l][4]}var d=map_object_index.indexOf(n);var j=map_objects[d].object;if(!j){continue}if(k==[]){fx_sprite_stop(j)}else{fx_sprite_animate(j,f,k,u)}}else{if(m=="ACTIONGRID"){if($defined(g.message[l][1])){wgrid_design(g.message[l][1],true);wgrid_show()}}else{if(m=="POLLINTERVAL"){feeder_interval=g.message[l][1]}}}}}}}if(m=="MSGBOX"){window.alert(t)}else{if(m=="POPUP"){var b=310;if($defined(g.message[l][3])){b=g.message[l][3]}var h=(screen.width-b)/2;var s=120;var q=false;if($defined(g.message[l][4])){if(g.message[l][4]!=false){h=g.message[l][4]}}if($defined(g.message[l][5])){if(g.message[l][5]!=false){s=g.message[l][5]}}if($defined(g.message[l][6])){if(g.message[l][6]!=false){q=g.message[l][6]}}createWindow(g.message[l][2],g.message[l][1],h,s,b,false,q)}else{if(m=="CALL"){var o=true;if($defined(g.message[l][2])){o=g.message[l][2]}gloryIO(t,false,o)}else{if(m=="NAVIGATE"){window.location="index.php?a="+t}else{callback.call("message",g.message[l])}}}}}}}var data_io_time=0;function gloryIO(b,g,a,f){try{if(!$defined($("datapane"))){library_mode=true;if(b.indexOf("?")>=0){b+="&lib=1"}else{b+="?lib=1"}}else{library_mode=false;reset_feeder()}if(!a){showStatus('Loading...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/UI/mouseloading.gif" />')}data_io_time=$time();var d=new Json.Remote(b,{onComplete:function(o){showStatus();data_io_time=$time()-data_io_time;var p="NONE";if($defined(o.mode)){p=o.mode}if(!library_mode){if(p=="MAIN"){var q="";var t="";var w="";if($defined(o.head_link)){q=o.head_link}if($defined(o.head_image)){t=o.head_image}if($defined(o.title)){w=o.title}nav_grid=[];overlay_grid=[];resetRegion();piemenu_dispose();disposeActionPane();map_curtain(true).chain(function(){displayBuffer(o.text,q,t,w);map_curtain(false)})}else{if(p=="GRID"){resetRegion();var x=false;var q="";var t="";var w="";var j="none.gif";if($defined(o.rollback)){x=o.rollback}if($defined(o.head_link)){q=o.head_link}if($defined(o.head_image)){t=o.head_image}if($defined(o.title)){w=o.title}if($defined(o.background)){j=o.background}grid_display.rollback=x;grid_display.head_link=q;grid_display.head_image=t;grid_display.background=j;grid_display.title=w;if($defined(o.x)){grid_x=o.x}if($defined(o.y)){grid_y=o.y}if($defined(o.map)){if(map_current!=o.map){map_curtain(true);map_reset();map_loadbase(o.map)}}if($defined(o.objects)){$each(o.objects,function(B,e){if($defined(B.image)){var A=new String(B.image);if(A.indexOf(".php")>0){}else{o.objects[e].image="images/"+B.image}}});map_preloaded_update(o.objects)}}}}if(p=="POPUP"){var l=100;var v=20;var k=310;var z=false;var u=false;if($defined(o.left)){l=o.left}if($defined(o.top)){v=o.top}if($defined(o.width)){k=o.width}if($defined(o.height)){k=o.height}if($defined(o.guid)){u=o.guid}createWindow(o.title,o.text,l,v,k,z,u)}else{if(p=="INFO"){}else{if(p=="FULL"){}else{if(p=="BLANK"){}else{if(p=="NONE"){}else{if(p=="DEDICATED"){var z=210;var k=400;if($defined(o.height)){z=o.height}if($defined(o.width)){k=o.width}try{ddwin_show(k,z,o.text)}catch(s){window.alert("DDWin Show Error: "+s)}}else{if(p=="DROPDOWN"){var n=[];var y=[];if($defined(o.menus)){n=o.menus}if($defined(o.text)){y=o.text}if(pie_wait_icon){piemenu_show(n,y)}}else{if(p=="ERROR"){if($defined(o.number)){if(o.number==101){alert("Game session is lost! You are logged out from the game.");window.location="index.php?a=interface.entry"}}else{if(!a){showStatus('<font color="red">'+o.error+"</font>",5000)}}}else{callback.call("ioreply",o)}}}}}}}}if($defined(o.messages)){handleMessages(o.messages)}try{var r=/a=(.*)&/i;var m=r.exec(b+"&");if(!$chk(m)){callback.call("iocomplete",false,o)}else{callback.call("iocomplete",m[1],o)}}catch(s){window.alert("RegEx Error: "+s)}if(f){f(o)}},onFailure:function(e){window.alert("JSON Error: "+$trace(e));if(!a){showStatus('<font color="red">Connection failure!</font>',1000)}if(f){f(false)}}}).send(g)}catch(h){window.alert("GloryIO Error: "+obj.message);if(!a){showStatus('<font color="red">Data Error!</font>',1000)}}}var data_grid=false;var collision_grid=false;var data_dictionary=false;var grid_range=false;var overlay_grid=false;var nav_grid=false;var current_map="";var glob_x_base=0;var glob_y_base=0;var grid_x=0,grid_y=0;var grid_display={rollback:false,head_link:false,head_image:false,title:false,background:"none.gif"};var rectinfo={w:3,h:3,bx:1,by:2,url:"",clickdispose:false,silent:false};var fx_sprites_animating=[];function fx_sprite_frame(h){if(!$defined(h)){return}var f=fx_sprites_animating[h];var g=f.frame+1;var d=f.animation.length;if(g>=d){g=0;if(f.callback){f.callback(f.object)}if(!f.loops){}else{f.loops--;if(f.loops==0){fx_sprite_stop(f.object);return}}}f.frame=g;var e=f.animation[g];var b=e[0]*f.sprite_w;var a=e[1]*f.sprite_h;f.object.setStyles({top:-a,left:-b})}function fx_sprite_undo(a){var e=$(a).getStyles("left","top");var d=$(a).getChildren()[0];var b=$(a).getParent();a.remove();d.inject(b);d.setStyles({left:e.left.toInt(),top:e.top.toInt()});return d}function fx_sprite_prepare(e,d,b){var f=$(e).getStyles("left","top");var h=$(e).getSize().size;var j={x:f.left.toInt(),y:f.top.toInt()};if(isNaN(j.x)){j.x=0}if(isNaN(j.y)){j.y=0}var a=new Element("div");var g={object:e,mask:a,width:h.x,height:h.y,sprite_w:Math.round(h.x/d),sprite_h:Math.round(h.y/b),animation:[],frame:0,timer:0,loops:0,callback:null};a.setStyles({width:g.sprite_w,height:g.sprite_h,overflow:"hidden",position:"absolute",left:j.x,top:j.y});$(e).setStyles({position:"absolute"});a.injectBefore(e);$(e).injectInside(a);fx_sprites_animating.push(g);return a}function fx_sprite_update(b,e,d,a){var h=$(b).getChildren()[0];var j=fx_sprite_get_id(b);e.inject(b);var g=$(e).getSize().size;e.remove();var f=fx_sprites_animating[j];f.width=g.x;f.height=g.y;f.sprite_w=Math.round(g.x/d);f.sprite_h=Math.round(g.y/a);b.setStyles({width:f.sprite_w,height:f.sprite_h});h.setStyles({left:0,top:0});h.src=e.src;fx_sprites_animating[j]=f;return b}function fx_sprite_get_id(a){for(var b=0;b<fx_sprites_animating.length;b++){if(fx_sprites_animating[b].object==a){return b}else{if(fx_sprites_animating[b].mask==a){return b}}}return -1}function fx_sprite_animate(b,e,g,a,f){var d=fx_sprite_get_id(b);if(d<0){return false}var h=fx_sprites_animating[d];h.animation=g;h.frame=0;h.loops=a;h.callback=f;if(h.timer!=0){Interval.remove(h.timer)}h.timer=Interval.add(fx_sprite_frame,(1000/e),d);return true}function fx_sprite_stop(d,g){var e=fx_sprite_get_id(d);if(e<0){return false}var f=fx_sprites_animating[e];Interval.remove(f.timer);if(!g){g=f.animation[0]}var b=g[0]*f.sprite_w;var a=g[1]*f.sprite_h;f.object.setStyles({top:-a,left:-b});return true}var map_dynamic_objects=[];var map_objects=[];var map_object_index=[];var map_info=[];var map_back=[];var map_curtain_status=false;var map_curtain_fx=null;var map_scroll_pos={x:0,y:0};var map_last_id=1;var map_viewpoint={x:0,y:0};var map_center_fx=null;var map_current="";var map_playeruid=0;function map_center(a,d,b){if(!a){a=map_viewpoint.x}if(!d){a=map_viewpoint.y}if(map_center_fx){map_center_fx.stop()}map=new Fx.Styles($("datapane"),{duration:400,unit:"px",transition:Fx.Transitions.Expo.easeInOut});map.start({left:-a+384,top:-d+256});map_center_fx=map;if(b){map_viewpoint={x:a,y:d}}}function map_scroll(a,b){if(!$defined(a)){a=map_scroll_pos.x}if(!$defined(b)){b=map_scroll_pos.y}$("datapane").setStyles({left:a,top:b});return;$each(map_objects,function(f,d){f.object.setStyles({left:f.x-a,top:f.y-b})});$each(map_back,function(f,d){f.object.setStyles({left:f.x-a,top:f.y-b})});map_scroll_pos={x:a,y:b}}function map_curtain(a){if(map_curtain_fx){map_curtain_fx.stop()}map_curtain_fx=new Fx.Styles($("dataloader"),{duration:400,unit:"px",transition:Fx.Transitions.Expo.easeInOut});if(a&&!map_curtain_status){showStatus();map_curtain_status=true;map_curtain_fx.element.setStyles({visibility:""});return map_curtain_fx.start({opacity:1,height:512})}else{if(!a&&map_curtain_status){map_curtain_status=false;return map_curtain_fx.start({opacity:0,height:1}).chain(function(){this.element.setStyles({visibility:"hidden"})})}}}function map_reset(){$each(map_objects,function(b,a){b.object.remove()});$each(map_back,function(b,a){b.object.remove()});map_current="";map_center_fx=null;map_scroll_pos={x:0,y:0};map_dynamic_objects=[];map_objects=[];map_info=[];map_back=[];map_object_index=[];map_last_id=1;map_viewpoint={x:0,y:0}}function map_loadbase(b){clearDisplayBuffer();$("databuffer").setStyle("visibility","hidden");$("datapane").setStyle("visibility","visible");showStatus("Loading Map...");map_current=b;var a=new Json.Remote("data/maps/"+b+".map",{onComplete:function(d){map_info=d;map_preload()},onFailure:function(d){map_info={name:b,error:d.message}}}).send()}function map_preload(){showStatus("Loading Graphics...");var e=null;var d=false;var b=map_info.images;$each(b,function(j,g){var h=new String(j);if(h.indexOf(".php")>0){}else{b[g]="images/elements/"+j}});for(var a=0;a<map_info.background.xsize;a++){for(var f=0;f<map_info.background.ysize;f++){b.push("data/maps/"+map_info.background.name+"-"+a+"-"+f+".png")}}b.push("images/tiles/"+map_info.background);ImageLoader.preload(b,{onComplete:function(){d=true;if(e){clearTimeout(e);e=null}map_finalize()},onProgress:function(j,g){if(!d){var h=Math.ceil(100*j/b.length);if(h>100){h-=100}showStatus("Loading Graphics ["+h+" %]");if(e){clearTimeout(e);e=null}e=setTimeout(map_finalize,2000)}}})}function map_finalize(){$("datahost").setStyles({"background-image":"url(images/tiles/"+map_info.background.fill+")"});var b=0;for(var a=0;a<map_info.background.xsize;a++){for(var f=0;f<map_info.background.ysize;f++){var d="data/maps/"+map_info.background.name+"-"+a+"-"+f+".png";var e=$(document.createElement("img"));e.setProperty("src",d);$("datapane").appendChild(e);e.setStyles({left:(a*map_info.background.width),top:(f*map_info.background.height),position:"absolute",width:map_info.background.width,height:map_info.background.height});map_back.push({object:e,x:(a*map_info.background.width),y:(f*map_info.background.height)})}}showStatus("Rendering Map...");$each(map_info.objects,function(g){g.image=map_info.images[g.image];map_addobject(g)});map_curtain(false);showStatus()}function map_objecttrigger(j,f,k){try{var b=getScrollPosition();var a=map_object_index.indexOf(j);if(f=="contextmenu"){piemenu_dispose();if($defined(map_objects[a].info.guid)){piemenu_init(k.client.x+b.x,k.client.y+b.y,map_objects[a].info.guid,"MAP")}}else{if(f=="mousemove"){if($defined(map_objects[a].info.name)){var l=map_objects[a].info.name;if($defined(map_objects[a].info.subname)){l+='<br /><font color="#33FF33" size="1"><em>'+map_objects[a].info.subname+"</em></font>"}hoverShow(l,k.client.x+b.x,k.client.y+b.y);if($defined(map_objects[a].info.range)){var m=map_objects[a].object.getPosition();var d=map_objects[a].object.getSize().size;var g=m.y+(d.y/2);if(k.client.y+b.y>g){if(!wgrid_visible){wgrid_design(map_objects[a].info.range);wgrid_show()}}}}}else{if(f=="click"){if($defined(map_objects[a].info.range)){if(!wgrid_visible){wgrid_design(map_objects[a].info.range);wgrid_show()}}else{if($defined(map_objects[a].info.click)){gloryIO(map_objects[a].info.click,false,false)}}}else{if(f=="mouseout"){hoverShow(false);if(!wgrid_hard_dispose){wgrid_hide()}}}}}}catch(k){window.alert("Object Trigger Error: "+k)}}var map_preloaded_stack=[];function map_preloaded_update(e){var a=[];var d=null;var b=false;$each(e,function(g,f){if(map_preloaded_stack.indexOf(g.image)<0){a.push(g.image);map_preloaded_stack.push(g.image)}else{}});if(a.length>0){showStatus("Loading new objects...");ImageLoader.preload(a,{onComplete:function(){showStatus();map_updatedata(e)},onProgress:function(f){}})}else{map_updatedata(e)}}function map_updatedata(d){if(map_dynamic_objects.length==0){map_dynamic_objects=d;$each(d,function(n,j){map_dynamic_objects[j].index=map_addobject(n)})}else{var h=[];var g=[];var b=[];for(var e=0;e<map_dynamic_objects.length;e++){var m=false;var k=false;for(var a=d.length-1;a>=0;a--){if($defined(d[a].id)&&$defined(map_dynamic_objects[e].id)){if(d[a].id==map_dynamic_objects[e].id){m=true;h.push(a);k=d[a];break}}else{if((d[a].x==map_dynamic_objects[e].x)&&(d[a].y==map_dynamic_objects[e].y)&&(d[a].image==map_dynamic_objects[e].image)){m=true;h.push(a);break}}}if(!m){g.push(map_dynamic_objects[e].index)}else{if(k!=false){b.push({index:map_dynamic_objects[e].index,cdata:k})}}}for(var e=g.length-1;e>=0;e--){map_removeobject(g[e])}map_dynamic_objects=[];for(var e=0;e<b.length;e++){b[e].cdata.index=b[e].index;map_dynamic_objects.push(b[e].cdata);map_updateobject(b[e].index,b[e].cdata)}for(var e=0;e<d.length;e++){if(h.indexOf(e)<0){var l=d[e];var f=map_addobject(l);l.index=f;map_dynamic_objects.push(l)}}}}function map_addobject(b){if(!$defined(b.cx)){b.cx=0}if(!$defined(b.cy)){b.cy=0}callback.call("object_put",b);var g=ImageLoader.get(b.image);$("datapane").appendChild(g);if($defined(b.sprite)){g=fx_sprite_prepare(g,b.sprite[0],b.sprite[1])}var k=g.getSize().size;var h=b.x*32-b.cx;var f=b.y*32-b.cy-k.y;var j=(b.y-1)*500+h;if(j<0){j=1}g.setStyles({position:"absolute",left:h,top:f,"z-index":j});var d=map_last_id++;var a=map_objects.length;map_object_index[a]=d;map_objects[a]={info:b,x:h,y:f,width:k.x,height:k.y,cx:b.cx,cy:b.cy,object:g};if($defined(b.player)){map_playeruid=d}if(b.dynamic){g.addEvent("contextmenu",function(l){var l=new Event(l);map_objecttrigger(d,"contextmenu",l);l.stop()});g.addEvent("mousemove",function(l){var l=new Event(l);g.setStyles({opacity:0.7});map_objecttrigger(d,"mousemove",l);l.stop()});g.addEvent("mouseout",function(l){var l=new Event(l);g.setStyles({opacity:1});map_objecttrigger(d,"mouseout",l);l.stop()});g.addEvent("mousedown",function(l){var l=new Event(l);map_objecttrigger(d,"mousedown",l);l.stop()});g.addEvent("mouseup",function(l){var l=new Event(l);map_objecttrigger(d,"mouseup",l);l.stop()});g.addEvent("click",function(l){var l=new Event(l);map_objecttrigger(d,"click",l);l.stop()});if($defined(b.fx_show)){switch(b.fx_show){case"fade":var e=new Fx.Styles(g,{wait:false,duration:400,transition:Fx.Transitions.Quad.easeIn});g.setStyles({opacity:0});e.start({opacity:1});break;case"pop":var e=new Fx.Styles(g,{wait:false,duration:400,transition:Fx.Transitions.Back.easeOut});g.setStyles({opacity:0,top:f+32});e.start({opacity:1,top:f});break;case"drop":var e=new Fx.Styles(g,{wait:false,duration:400,transition:Fx.Transitions.Bounce.easeOut});g.setStyles({opacity:0,top:f-200});e.start({opacity:1,top:f});break;case"zoom":var e=new Fx.Styles(g,{wait:false,duration:400,transition:Fx.Transitions.Quad.easeIn});g.setStyles({opacity:0,width:5,height:5,left:(h+(k.x/2)),top:(f+(k.y/2))});e.start({opacity:1,width:k.x,height:k.y,left:h,top:f});break}}if($defined(b.focus)){map_center(h+Math.ceil(k.x/2),f+Math.ceil(k.y/2),true)}}return d}function map_removeobject(e,a){var g=map_object_index.indexOf(e);var f=map_objects[g];if(!f){return}callback.call("object_remove",f.info);var d=function(){f.object.remove();map_objects.splice(g,1);map_object_index.splice(g,1)};if(f.info.fx_hide&&!a){switch(f.info.fx_hide){case"fade":var b=new Fx.Styles(f.object,{wait:false,duration:400,transition:Fx.Transitions.Quad.easeOut});b.start({opacity:0}).chain(d);break;case"pop":var b=new Fx.Styles(f.object,{wait:false,duration:400,transition:Fx.Transitions.Back.easeIn});b.start({opacity:0,top:f.y+32}).chain(d);break;case"drop":var b=new Fx.Styles(f.object,{wait:false,duration:400,transition:Fx.Transitions.Back.easeIn});b.start({opacity:0,top:f.y-200});break;case"zoom":var b=new Fx.Styles(f.object,{wait:false,duration:400,transition:Fx.Transitions.Quad.easeIn});b.start({opacity:0,width:5,height:5,left:(f.x+(f.width/2)),top:(f.y+(f.height/2))});break;default:d()}}else{d()}}var map_fx_pathmove_stack=[];function map_fx_pathmove(a,d,b){if($defined(map_fx_pathmove_stack[a.info.id])){map_fx_pathmove_stack[a.info.id].push([a,d])}else{map_fx_pathmove_stack[a.info.id]=[];map_fx_pathmove_stack[a.info.id].push([a,d]);map_fx_pathmove_next(a.info.id,b)}}function map_fx_pathmove_next(d,a){$trace("Moving next");if($defined(map_fx_pathmove_stack[d])){if(map_fx_pathmove_stack[d].length==0){map_fx_pathmove_stack.splice(d,1);if(a){a()}}else{var b=map_fx_pathmove_stack[d].shift();map_fx_pathmove_thread(b[0],b[1],a)}}}function map_fx_pathmove_build_spritepath(d,e){var j={rd:3,ru:3,r:3,ld:1,lu:1,l:1,u:2,d:0};var a={walk:[1,2,3,4,5],stay:0};if($defined(d.info.sprite_direction_grid)){j=d.info.sprite_direction_grid}if($defined(d.info.sprite_direction_ani)){a=d.info.sprite_direction_ani}var h=0;if(!$defined(j[e])){if(e.length==2){if($defined(j[e[0]])){h=j[e[0]]}}}else{h=j[e]}var g=[];for(var b=0;b<a.walk.length;b++){g.push([a.walk[b],h])}var f=[a.stay,h];return[g,f]}function map_fx_pathmove_thread(a,m,k){var s=0;var l;var b=[0,0];var n=a.info.id;var x=a.object;var w="";var u="";var q=0;if($defined(a.info.directional)){q=a.info.directional}var t=5;if($defined(a.info.speed)){t=a.info.speed}var r=1000-(t*100);if(r<10){r=10}var h=t*2;if(h<1){h=1}var o=new Fx.Styles(x,{duration:r,unit:"px",transition:Fx.Transitions.linear});var d=function(){if(!$defined(m[s])){fx_sprite_stop(x,b);map_fx_pathmove_next(n,k);return}var B=s;s++;if(B<1){var y=$(x).getStyles("left","top");var I=Math.round(y.left.toInt()/32);var H=Math.round(y.top.toInt()/32)}else{var I=m[B-1].x;var H=m[B-1].y}var F=m[B].x;var E=m[B].y;var C=F-I;var A=E-H;if((C==0)&&(A==0)){d();return}if(q){var z=false;b=[0,0];if(C>0){if(A>0){l=map_fx_pathmove_build_spritepath(a,"rd");z=l[0];b=l[1];u="rd"}else{if(A<0){l=map_fx_pathmove_build_spritepath(a,"ru");z=l[0];b=l[1];u="ru"}else{l=map_fx_pathmove_build_spritepath(a,"r");z=l[0];b=l[1];u="r"}}}else{if(C<0){if(A>0){l=map_fx_pathmove_build_spritepath(a,"ld");z=l[0];b=l[1];u="ld"}else{if(A<0){l=map_fx_pathmove_build_spritepath(a,"lu");z=l[0];b=l[1];u="lu"}else{l=map_fx_pathmove_build_spritepath(a,"l");z=l[0];b=l[1];u="l"}}}else{if(A>0){l=map_fx_pathmove_build_spritepath(a,"d");z=l[0];b=l[1];u="d"}else{if(A<0){l=map_fx_pathmove_build_spritepath(a,"u");z=l[0];b=l[1];u="u"}else{}}}}if(z!=false){if(w!=u){fx_sprite_animate(x,h,z);w=u}}}var D=x.getSize().size;var G=Math.round(D.y/32);var J=(Number(m[B].y)+G)*500+Number(m[B].x);if(J<0){J=1}x.setStyle("z-index",J);o.start({left:m[B].x*32,top:m[B].y*32-D.y+32}).chain(d)};var v=$(x).getStyles("left","top");var p=$(x).getSize().size;var f=Math.round(v.left.toInt()/32);var e=Math.round(v.top.toInt()/32);var j=m[m.length-1].x;var g=m[m.length-1].y-1;if((f==j)&&(e==g)){return}d()}function map_objectid_fromguid(a){for(var b=0;b<map_objects.length;b++){if(map_objects[b].info.guid==a){return map_object_index[b]}}return 0}var map_fxstack=[];function map_stack_movefx(f,g,h,a,j,e,d){var b=2;pos=g.object.getStyles("left","top");pos.left=pos.left.toInt();pos.top=pos.top.toInt();if((Math.abs(pos.left-a)<b)&&(Math.abs(pos.top-j)<b)){return}if(!$defined(map_fxstack[f])){map_fxstack[f]=[];map_fxstack[f].push([f,g,h,a,j,e,d]);map_stack_movefx_next(f)}else{map_fxstack[f].push([f,g,h,a,j,e,d])}}function map_stack_movefx_next(b){if($defined(map_fxstack[b])){if(map_fxstack[b].length==0){map_fxstack.splice(b,1)}else{var a=map_fxstack[b].shift();map_stack_movefx_thread(a[0],a[1],a[2],a[3],a[4],a[5],a[6])}}else{}}function map_stack_movefx_thread(d,f,a,h,g,k,l){if(a.fx_move){switch(a.fx_move){case"slide":var b=new Fx.Styles(f.object,{duration:800,unit:"px",transition:Fx.Transitions.linear});var j=new Fx.Styles(f.object,{duration:800,unit:"",transition:Fx.Transitions.linear});j.start({"z-index":k});b.start({top:g}).chain(function(){b.start({left:h})}).chain(function(){map_stack_movefx_next(d)});break;case"bounce":var b=new Fx.Styles(f.object,{duration:800,unit:"px",transition:Fx.Transitions.Elastic.easeOut});b.start({left:h,top:g}).chain(function(){map_stack_movefx_next(d)});f.object.setStyles({"z-index":k});break;case"fade":var e=new Fx.Styles(f.object,{wait:false,duration:400,transition:Fx.Transitions.Quad.easeOut});e.start({opacity:0}).chain(function(){f.object.setStyles({left:h,top:g,"z-index":k});e.start({opacity:1}).chain(function(){map_stack_movefx_next(d)})});break;case"path":if($defined(a.fx_path)){map_fx_pathmove(f,a.fx_path,function(){map_stack_movefx_next(d)});delete a.fx_path;break}default:f.object.setStyles({left:h,top:g,"z-index":k});map_stack_movefx_next(d)}}else{f.object.setStyles({left:h,top:g,"z-index":k});map_stack_movefx_next(d)}}function map_updateobject(d,b){try{var a=map_object_index.indexOf(d);var g=map_objects[a];if(!g){return}callback.call("object_update",{old:g,"new":b});if(!$defined(b.cx)){b.cx=g.cx}if(!$defined(b.cy)){b.cy=g.cy}if(!$defined(b.x)){b.x=g.info.x}if(!$defined(b.y)){b.y=g.info.y}if($defined(b.image)){if(g.info.image!=b.image){if($defined(g.info.sprite)){if(!$defined(b.sprite)){g.object=fx_sprite_undo(g.object);g.object.src=b.image}else{fx_sprite_update(g.object,ImageLoader.get(b.image),b.sprite[0],b.sprite[1])}}else{g.object.src=b.image}}}for(i in g.info){if(!$defined(b[i])){b[i]=g.info[i]}}var l=g.object.getSize().size;var j=b.x*32-b.cx;var h=b.y*32-b.cy-l.y;var k=(b.y-1)*500+j;if(k<0){k=1}g.x=j;g.y=h;g.width=l.x;g.height=l.y;g.info=b;if($defined(b.player)){map_playeruid=d}map_stack_movefx(d,g,b,j,h,k,l);if($defined(b.focus)){map_center(j+Math.ceil(g.width/2),h+Math.ceil(g.height/2),true)}}catch(f){alert("Error updating UID "+d+": "+$trace(f))}}var wgrid_elements=[];var wgrid_host=null;var wgrid_pos={x:0,y:0};var wgrid_last_design_pos={x:0,y:0};var wgrid_visible=false;var wgrid_dispose_timer=null;var wgrid_hard_dispose=false;function wgrid_show(){if(wgrid_dispose_timer!=null){clearTimeout(wgrid_dispose_timer);wgrid_dispose_timer=null}if(wgrid_host==null){return}if(wgrid_visible){return}wgrid_host.setStyle("display","");wgrid_visible=true}function wgrid_hide(){if(!wgrid_visible){return}wgrid_dispose_timer=window.setTimeout(function(){try{wgrid_host.setStyle("display","none");wgrid_visible=false}catch(a){}},200)}function wgrid_dispose(a){try{$each(wgrid_elements,function(d){d.remove()});wgrid_host.remove()}catch(b){}if(wgrid_dispose_timer!=null){clearTimeout(wgrid_dispose_timer);wgrid_dispose_timer=null}wgrid_elements=[];wgrid_host=null;wgrid_pos={x:0,y:0};wgrid_visible=false;if(!$defined(a)){wgrid_last_design_pos={x:0,y:0}}}function wgrid_put(a,g,b,d){var f=$(document.createElement("a"));f.setProperty("href","javascript:;");f.setHTML("&nbsp;");f.addEvent("click",function(h){var h=new Event(h);wgrid_dispose();gloryIO(b,{id:d.id},true);h.stop()});wgrid_host.appendChild(f);f.setStyles({left:a*32,top:g*32,display:"block",width:32,height:32,"background-color":"#00FF00",position:"absolute",opacity:0.5,"text-decoration":"none"});if($defined(d.color)){f.setStyle("background-color",d.color)}if($defined(d.title)){f.setProperty("title",d.title)}wgrid_elements.push(f)}function wgrid_design(d,a){var b=[];wgrid_hard_dispose=a;wgrid_dispose(true);wgrid_host=$(document.createElement("div"));wgrid_host.setStyles({position:"absolute",visibility:"visible","background-color":"#000000",left:0,top:0,"z-index":lastZ++});$("datapane").appendChild(wgrid_host);if(!a){wgrid_host.addEvent("mouseleave",function(f){wgrid_hide()});wgrid_host.addEvent("mouseenter",function(f){wgrid_show()})}$each(d.grid,function(f){wgrid_put(f.x,f.y,d.base,f)});wgrid_visible=true}var hoverInfo={text:"",x:0,y:0,sz:{x:0,y:0}};function hoverShow(f,a,h,g){var b=$("hoverLayer");if(f){if(hoverInfo.text!=f){hoverInfo.text=f;b.setHTML(f);hoverInfo.sz=b.getSize().size;b.setStyles({visibility:"visible"})}if(hoverInfo.x!=a||hoverInfo.y!=h){hoverInfo.x=a;hoverInfo.y=h;var e=a-(hoverInfo.sz.x/2);var d=h-hoverInfo.sz.y-12;if(d<0){d+=hoverInfo.sz.y+24}if(!g||(g=="center")){e=a-(hoverInfo.sz.x/2)}else{if(g=="left"){e=a}else{if(g=="right"){e=a-hoverInfo.sz.x}}}b.setStyles({left:e,top:d,"z-index":lastZ})}}else{if(hoverInfo.text!=""){hoverInfo={text:"",x:0,y:0,sz:{x:0,y:0}};b.setStyles({visibility:"hidden"})}}}var dropdownInfo={visible:false};function dropdownShow(b,g,d,a,f){if(!f){f=0}var e=$("dropdownLayer");e.setHTML('<img src="images/UI/loading2.gif" align="absmiddle" />');e.setStyles({visibility:"visible",left:b-5,top:g-5});dropdownInfo.visible=true;gloryIO("?a=interface.dropdown&guid="+d+"&pos="+a+"&parent="+f,false,true);e.focus();e.addEvent("mouseleave",function(){disposeDropDown()})}function disposeDropDown(){var a=$("dropdownLayer");if(dropdownInfo.visible){a.setStyles({visibility:"hidden"});dropdownInfo.visible=false}}var regions=[];var visibleRegionID=-1;var activeEvent=false;var region_showing=false;var region_showing_fx=null;function stackRegion(a){regions.push(a)}function resetRegion(){disposeActionPane();regions=[];visibleRegionID=-1}function hitTestRegion(a,d){if(visibleRegionID>-1){if(region_showing){if((a!=regions[visibleRegionID].show.x)||(d!=regions[visibleRegionID].show.y)){abortActionPaneRender()}}return}for(var b=0;b<regions.length;b++){if((regions[b].show.x==a)&&(regions[b].show.y==d)){showRegion(b);return}}}function showRegion(a){renderActionRange(regions[a]);visibleRegionID=a;hoverShow(false)}function disposeActionPane(d){if(visibleRegionID==-1){return}var a=$("actionpane");if(!d){var b=new Fx.Styles(a,{duration:500,transition:Fx.Transitions.Cubic.easeOut});b.start({opacity:0}).chain(function(){a.setStyles({visibility:"hidden"})})}else{a.setStyles({visibility:"hidden"})}visibleRegionID=-1}function renderActionRange(d){hoverShow();try{var a=0;var h=0;var g='<table cellspacing="0" cellpadding="0">';for(h=d.y.m;h<=d.y.M;h++){g+="<tr>";for(a=d.x.m;a<=d.x.M;a++){if($defined(d.grid[h])){if($defined(d.grid[h][a])){var b="";if($defined(d.grid[h][a].c)){b+="background-color:"+d.grid[h][a].c+"; "}if($defined(d.grid[h][a].b)){b+="background-image:url("+d.grid[h][a].b+"); "}g+='<td><a href="javascript:void(0);" onclick=";gloryIO(\'?a='+d.action+"&id="+d.grid[h][a].i+'\');" class="actgrid_link" style="'+b+'">';if($defined(d.grid[h][a].t)){g+=d.grid[h][a].t}else{g+="&nbsp;"}g+="</a></td>"}else{g+='<td><div class="actgrid_div">&nbsp;</div></td>'}}else{g+='<td><div class="actgrid_div">&nbsp;</div></td>'}}g+="</tr>"}g+="</table>";renderActionPane(g,d.point.x-glob_x_base,d.point.y-glob_y_base)}catch(f){window.alert("RenderActionRange Error: "+f)}}function renderActionPane(d,a,g){var b=$("actionpane");var f=$("datapane").getLeft();var e=$("datapane").getTop();b.setHTML(d);b.setStyles({visibility:"visible",opacity:0,left:(a*32-12)+f,top:(g*32-12)+e});b.addEvent("click",function(h){h=new Event(h);h.stop()});b.addEvent("mouseleave",function(h){h=new Event(h);disposeActionPane();h.stop()});region_showing_fx=new Fx.Styles("actionpane",{duration:500,transition:Fx.Transitions.Cubic.easeIn,onComplete:function(){region_showing=false}});region_showing=true;region_showing_fx.start({opacity:0.8}).chain(function(){hoverShow(false)})}function abortActionPaneRender(){if(region_showing){region_showing_fx.stop();region_showing=false;disposeActionPane(true)}}var feeder_interval=5000;var feeder_timer=0;var feeder_enabled=true;var iD=0;function reset_feeder(){if(feeder_timer){clearTimeout(feeder_timer)}if(feeder_enabled){feeder_timer=setTimeout(feeder,feeder_interval)}}function feeder(){iD++;gloryIO("msgfeed.php",false,true,function(a){reset_feeder()})}var pie_stack=[];var pie_info=[];var pie_wait_icon=null;var pie_menutext=null;var pie_visible=false;function piemenu_dispose(){if(pie_stack.length>=0){for(var a=0;a<pie_stack.length;a++){var b=new Fx.Styles(pie_stack[a],{duration:400,transition:Fx.Transitions.Back.easeIn,onComplete:function(){this.element.remove()}});b.start({opacity:0,left:pie_info.x-17,top:pie_info.y-17})}pie_stack=[]}pie_info=[];if(pie_menutext){var b=new Fx.Styles(pie_menutext,{duration:400,transition:Fx.Transitions.Back.easeIn,onComplete:function(){this.element.remove()}});b.start({opacity:0});pie_menutext=null}piemenu_waitdispose();pie_visible=false}function piemenu_spawnicon(j,g,h,k,a){try{var l=$(document.createElement("div"));l.setStyles({width:"34px",height:"34px",position:"absolute","background-repeat":"no-repeat","background-image":"url(images/UI/icon-bg.png)","text-align":"center",left:(pie_info.x-17)+"px",top:(pie_info.y-17)+"px",opacity:0,"z-index":lastZ++});var b=new Fx.Styles(l,{duration:400,transition:Fx.Transitions.Back.easeOut});var d=$(document.createElement("a"));d.setProperty("href","javascript:;");d.addEvent("click",function(m){m=new Event(m);piemenu_dispose();gloryIO(a);m.stop()});d.alt=k;d.title=k;var f=$(document.createElement("img"));f.src=h;f.border="0";d.appendChild(f);l.appendChild(d);pie_stack.push(l);$(document.body).appendChild(l);b.start({opacity:1,left:j-17+"px",top:g-17+"px"})}catch(e){}}function piemenu_show(d,m){pie_visible=true;try{piemenu_waitdispose();hoverShow();if(pie_info.length==0){return}var a=5+(d.length*5);if(m!=""){if(pie_menutext){pie_menutext.remove();pie_menutext=null}pie_menutext=$(document.createElement("div"));pie_menutext.setStyles({position:"absolute","background-color":"#000000","boder-width":"2px","border-style":"solid","border-color":"#CCCCCC","font-size":"10px",padding:"2px",opacity:0,"text-align":"center","z-index":lastZ++});var e=new Fx.Styles(pie_menutext,{duration:400,transition:Fx.Transitions.Back.easeIn});if(d.length>0){pie_menutext.setStyles({width:((a*2)+60)+"px"})}pie_menutext.setHTML(m);document.body.appendChild(pie_menutext);var l=pie_menutext.getSize();pie_menutext.setStyles({left:(pie_info.x-(l.size.x/2)),top:(pie_info.y+a+15)});e.start({opacity:1})}if(d.length>0){var g=(2*Math.PI)/d.length;var j=0;for(var h=0;h<d.length;h++){var f=pie_info.x+(a*Math.cos(j));var b=pie_info.y+(a*Math.sin(j));piemenu_spawnicon(f,b,d[h][0],d[h][1],d[h][2]);j+=g}}}catch(k){}}function piemenu_waitdispose(){try{if(pie_wait_icon){pie_wait_icon.remove();pie_wait_icon=null}}catch(a){}}function piemenu_wait(){piemenu_waitdispose();pie_wait_icon=$(document.createElement("img"));pie_wait_icon.src="images/UI/loading-big.gif";$(document.body).appendChild(pie_wait_icon);var a=pie_wait_icon.getSize();pie_wait_icon.setStyles({left:(pie_info.x-(a.size.x/2))+"px",top:(pie_info.y-(a.size.y/2))+"px",position:"absolute"})}function piemenu_init(b,f,d,a,e){pie_info={x:b,y:f};gloryIO("?a=interface.dropdown&guid="+d+"&pos="+a+"&parent="+e,false,true);piemenu_wait()}function iface_selecttab(a){for(var b=1;b<=4;b++){if(b!=a){$("tb"+b).setStyle("display","none");$("tl"+b).removeClass("active")}else{if($("tl"+b).hasClass("active")){$("tb"+b).setStyle("display","none");$("tl"+b).removeClass("active")}else{$("tb"+b).setStyle("display","");$("tl"+b).addClass("active")}}}}$(window).addEvent("load",function(a){iface_selecttab(3)});var hoveredItem=false;$(window).addEvent("load",function(a){if(!$("datapane")){return}initWaiter();initDisplayBuffer();$("datapane").addEvent("contextmenu",function(d){d=new Event(d);var b=getScrollPosition();if(hoveredItem!=false){piemenu_dispose();piemenu_init(d.event.clientX+b.x,d.event.clientY+b.y,hoveredItem.g,"MAP")}else{piemenu_dispose()}d.stop()});$("datapane").addEvent("mousedown",function(b){piemenu_dispose()});$("datapane").addEvent("click",function(g){g=new Event(g);var j=$("datapane").getLeft();var h=$("datapane").getTop();var d=getScrollPosition();var b=Math.ceil((g.event.clientX-j+d.x)/32)+glob_x_base-1;var f=Math.ceil((g.event.clientY-h+d.y)/32)+glob_y_base-1;if(rectinfo.url==""){hitTestRegion(b,f)}else{gloryIO(rectinfo.url+"&x="+b+"&y="+f);if(rectinfo.clickdispose){rectinfo.url="";$("grid_rect").setStyles({display:"none"})}}piemenu_dispose();gloryIO("?a=map.grid.get&x="+b+"&y="+f)});gloryIO("?a=map.grid.get");feeder()});$(window).addEvent("focus",function(a){return;feeder_enabled=true;if(feeder_timer==0){feeder_timer=setTimeout(feeder,1000)}});$(window).addEvent("blur",function(a){return;feeder_enabled=false;feeder_timer=0});var v_center={x:0,y:0},v_last={x:0,y:0};$(document).addEvent("keydown",function(d){if(!$("datapane")){return}d=new Event(d);if(d.code==27){var b=$("grid_rect");if(b){if(b.getStyle("display")!="none"){b.setStyles({display:"none"});rectinfo.url=""}}piemenu_dispose();d.stop()}else{if(d.control){if(d.key=="b"){d.stop();gloryIO("?a=interface.inventory")}else{if(d.key=="d"){d.stop();window.alert($trace(map_images))}}}else{if(d.key=="right"){v_center.x=200;d.stop()}else{if(d.key=="left"){v_center.x=-200;d.stop()}else{if(d.key=="up"){v_center.y=-200;d.stop()}else{if(d.key=="down"){v_center.y=200;d.stop()}else{if(d.key=="m"){var f=map_object_index.indexOf(map_playeruid);if(f>-1){var a=getScrollPosition();if($defined(map_objects[f].info.range)){if(!wgrid_visible){wgrid_design(map_objects[f].info.range);wgrid_show()}}}}}}}}}}if((v_center.x!=v_last.x)||(v_center.y!=v_last.y)){map_center(map_viewpoint.x+v_center.x,map_viewpoint.y+v_center.y);v_last.x=v_center.x;v_last.y=v_center.y}});$(document).addEvent("keyup",function(a){if(!$("datapane")){return}v_center={x:0,y:0};v_last={x:0,y:0};map_center(map_viewpoint.x,map_viewpoint.y)});$(document).addEvent("mouseup",function(a){if(!$("datapane")){return}piemenu_dispose();wgrid_hide()});$(document).addEvent("contextmenu",function(a){if(!$("datapane")){return}var a=new Event(a);piemenu_dispose();wgrid_hide()});var c=null;function moveto(a,b){if(c==null){c=new Element("img",{src:"images/UI/cursor/round.png"});c.inject($("datapane"));c.setStyles({"z-index":65535,position:"absolute"})}c.setStyles({left:a*32,top:b*32})}$(document).addEvent("click",function(g){if(!$("datapane")){return}g=new Event(g);if(g.rightClick){return}var k=$("datapane").getLeft();var h=$("datapane").getTop();var b=getScrollPosition();var a=g.event.clientX;var d=g.event.clientY;var f=$("datahost").getPosition();var j=$("datahost").getSize().size;if((a<f.x)||(a>(f.x+j.x))||(d<f.y)||(d>(f.y+j.y))){return}g.stop()});$(document).addEvent("mousemove",function(j){if(!$("datapane")){return}try{j=new Event(j);var n=$("datapane").getLeft();var m=$("datapane").getTop();var f=getScrollPosition();var d=Math.ceil((j.event.clientX-n+f.x)/32)-1;var k=Math.ceil((j.event.clientY-m+f.y)/32)-1;var l=d+glob_x_base;var g=k+glob_y_base;var b="";var h="";if($defined(nav_grid[l])){if($defined(nav_grid[l][g-1])){b=nav_grid[l][g-1];h=nav_grid.dic[b]}}if(h.d){hoveredItem=h}else{hoveredItem=false}moveto(l,g);if(!pie_visible){hitTestRegion(l,g);if(hoveredItem){hoverShow(h.d.name,j.event.clientX+f.x,j.event.clientY+f.y)}else{hoverShow(false)}var a=$("grid_rect");if(a){if(a.getStyle("display")!="none"){a.setStyles({left:(d-rectinfo.bx)*32,top:(k-rectinfo.by)*32,width:rectinfo.w*32,height:rectinfo.h*32,display:""})}}}}catch(j){}});function display(a){gloryIO("index.php?"+a)};